---
title: "Summary of List Experiment"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(dplyr)
library(tidyverse)
library(list)
library(car)
library(boot)
library(openxlsx)
library(ggplot2)
library(colorBlindness)

rm(list = ls())
set.seed(1201202)
setwd("/local/home/yufenlai/working_paper/carbon")

################################################################################
### Define functions
################################################################################

### make summary table
make_summary <-
    function(est) {
        tbl_temp <-
            lapply(
                1:n_ss,
                function(i) {
                    par <- est$par.treat[[i]]
                    se <- est$se.treat[[i]]
                    p <- 2 * (1 - pnorm(abs(par / se)))
                    star <- ifelse(
                        p < 0.01,
                        "***",
                        ifelse(
                            p < 0.05,
                            "**",
                            ifelse(p < 0.1, "*", "")
                        )
                    )
                    variable <- names(par)

                    names(par) <- NULL
                    names(se) <- NULL
                    names(p) <- NULL
                    names(star) <- NULL

                    return(
                        data.frame(
                            statement = statement_reference$statement[statement_reference$treatment == i],
                            variable = variable,
                            coefficient = par,
                            SE = se,
                            p = p,
                            star = star
                        )
                    )
                }
            )
        tbl_temp <- do.call(rbind, tbl_temp)
        return(tbl_temp)
    }

################################################################################
### Read in data
################################################################################
message("Reading in data...")
load("./image/sensitive_statements.RData")
dt_count <- fread("csv/dt_counts.csv")

### treatment reference
statement_reference <-
    dt_count %>%
    select(
        treatment,
        statement
    ) %>%
    distinct() %>%
    arrange(treatment)

### number of control lists
n_cl <- dt_count %>%
    select(list_id) %>%
    distinct() %>%
    nrow()

### n control statements
n_cs <- 4

### number of sensitive statements
n_ss <- dt_count %>%
    select(statement) %>%
    distinct() %>%
    filter(statement != "") %>%
    nrow()
```

## Validating the floor and ceiling of treatment groups
This step validates if the list experiment is working as intended.
Selecting floor or ceiling counts (namely, 0 or 5) for the treatment groups
will reveal the answer to the sensitive question.
The below plot shows that the floor and ceiling all combined is around 10%
of the total responses for each treatment group,
which should be comparable to the existing literature if not lower.
```{r validate_floor_ceiling, echo=FALSE, message = FALSE}
dt_count %>%
    filter(treatment != 0) %>%
    group_by(list_id, treatment, count) %>%
    summarise(n = n_distinct(ResponseId)) %>%
    ungroup() %>%
    group_by(list_id, treatment) %>%
    mutate(
        pct = n / sum(n),
        list_id = as.factor(list_id),
        treatment = case_when(
            treatment == 1 ~ "Restricting electricity",
            treatment == 2 ~ "Carbon tax",
            treatment == 3 ~ "Not commit zero emissions",
            treatment == 4 ~ "Mandatory energy efficiency"
        )
    ) %>%
    arrange(list_id, treatment, count) %>%
    # bar plot of density for each treatment and group by list_id
    ggplot(
        aes(
            x = count,
            y = pct,
            group = list_id
        )
    ) +
    geom_bar(
        stat = "identity",
        aes(fill = list_id),
        position = "dodge"
    ) +
    # show all values on x-axis
    scale_x_continuous(breaks = seq(0, n_cs + 1, 1)) +
    # display all treatment groups
    facet_wrap(~treatment, labeller = ) +
    # set color theme
    scale_fill_manual(values = Blue2DarkRed12Steps) +
    # scale y-axis to percentage
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    # set x-axis label
    labs(
        x = "Count",
        y = "Percentage of Responses",
        title = "Distribution of Floor and Ceiling Counts by Treatment Group"
    ) +
    # change legend title
    guides(fill = guide_legend(title = "List ID")) +
    theme_classic()
    
```

## Overall percentage of support for sensitive statements